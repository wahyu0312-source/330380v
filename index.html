<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>出荷検査成績書 オークマ専用 MB-80V</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* === (styling sama persis seperti yang kamu kirim) === */
    html,body{background:#e7e7e7;margin:0;padding:0;font-family:"Yu Gothic UI","Meiryo","MS PGothic",Arial,sans-serif;font-size:3.5mm;height:100%}
    .no-print{display:initial}.print-text{display:none}
    input,select{font-size:3.5mm;padding:.5mm;box-sizing:border-box;font-family:"Yu Gothic UI","Meiryo","MS PGothic",Arial,sans-serif}
    input[type="date"]{font-family:inherit;-webkit-appearance:none;appearance:none;line-height:1.2}
    table input,table input[type="date"],.td-measure-grid input{border:none;outline:none;background:transparent;box-shadow:none;border-radius:0;padding:0 1mm;width:100%;height:100%;box-sizing:border-box;-webkit-appearance:none;appearance:none}
    table input:focus,table input[type="date"]:focus{outline:none;box-shadow:none}
    @media screen{html,body{display:flex;flex-direction:column;align-items:center}.b5-preview{margin:12mm 0}}
    .b5-preview{background:#fff;width:176mm;max-width:98vw;margin:10mm auto;padding:8mm;box-shadow:0 0 5mm rgba(0,0,0,.25);box-sizing:border-box}
    h2{text-align:center;font-size:7mm;margin-bottom:8mm}
    table{width:100%;border-collapse:collapse;margin-bottom:4mm}
    th,td{border:.3mm solid #333;padding:1.2mm 1mm;text-align:center;background:#fff;vertical-align:middle}
    th{background:#f0f0f0}.section-label{text-align:left;font-weight:bold;background:#f9f9f9}
    .inspect-table th,.inspect-table td{line-height:4.6mm;white-space:normal;word-break:normal;line-break:strict;text-align:left}
    .inspect-table th:nth-child(3),.inspect-table td:nth-child(3){text-align:center}
    .header-table td,.header-table th{white-space:nowrap;word-break:keep-all}.header-table input{min-width:0}
    .button{margin:3mm 1mm 0 0;padding:2mm 8mm;font-size:3.5mm}
    .td-measure{padding:0!important}.td-measure-grid{display:grid;grid-template-columns:1fr auto;align-items:center;gap:1mm}.td-measure-grid input{text-align:right}
    .inputter-row{display:flex;align-items:center;gap:2mm;margin-bottom:3mm}.inputter-row label{width:12mm;font-weight:bold}.inputter-row select{width:30%}
    .stamp-box-row{display:flex;justify-content:flex-end;gap:4mm;margin-top:3mm}.stamp-box-row>div{display:flex;flex-direction:column;align-items:center}
    .stamp-label{font-size:3mm;margin-bottom:1mm;text-align:center}
    .signature-box{width:15mm;height:15mm;border:.3mm solid #333;border-radius:2mm;background:#fafbfc;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .signature-box img{width:9mm;height:9mm;object-fit:contain}
    .company-name{text-align:right;margin:2mm 1mm 0;font-weight:bold}
    .order-no-row .section-label{width:15%}.order-no-row .data{width:85%}
    .toolbar{position:fixed;top:12px;left:50%;transform:translateX(-50%);display:flex;gap:8px;padding:8px 10px;background:rgba(255,255,255,.92);border:1px solid #ddd;border-radius:12px;box-shadow:0 2px 18px rgba(0,0,0,.12);z-index:9999;backdrop-filter:blur(4px)}
    .toolbar button{font-family:"Yu Gothic UI","Meiryo","MS PGothic",Arial,sans-serif;font-size:14px;padding:8px 14px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .toolbar button:hover{filter:brightness(.96)}
    @media (max-width:560px){.toolbar{top:8px;gap:6px;padding:6px 8px}.toolbar button{padding:6px 10px;font-size:13px}}
    @media print{@page{size:B5 portrait;margin:12mm}html,body{background:none!important;margin:0!important;padding:0!important}.toolbar{display:none!important}
      .b5-preview{width:100%;margin:0;padding:0;box-shadow:none;box-sizing:border-box;transform:scale(.97);transform-origin:top left}
      table{width:100%}.no-print{display:none!important}.print-text{display:inline!important}
      table input,table input[type="date"],.td-measure-grid input{border:none!important;outline:none!important;background:transparent!important;box-shadow:none!important;border-radius:0!important}
      .signature-box img[src=""]{display:none!important}.stamp-box-row,.signature-box{display:flex!important}
      .inspect-table th,.inspect-table td{line-height:4.6mm!important}*{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
    .td-measure-grid input.invalid{background:#ffebee;box-shadow:inset 0 0 0 1px #d32f2f}
    @media print{.td-measure-grid input.invalid{background:transparent!important;box-shadow:none!important}}
    .inspect-table .col-judge{width:15%}.judge-td{padding:0}.judge-td .judge-select,.judge-td .print-text{display:inline-block;line-height:1.2;vertical-align:middle}
    .judge-td .print-text{min-width:8mm;text-align:center}@media print{.judge-td .print-text{display:inline-block!important}}
  </style>
</head>
<body>
  <div class="toolbar">
    <button type="button" onclick="printViaPDF()">🖨️ 印刷</button>
    <button type="button" onclick="savePdfToDrive()">📄 PDF保存（Drive直送）</button>
    <button type="button" onclick="clearAllFields()">🧹 全てクリア</button>
  </div>

  <!-- === FORM kamu (potongan sama seperti sebelumnya) === -->
  <form id="inspection-form">
    <div class="b5-preview">
      <h2>出荷検査成績書</h2>
      <table class="header-table">
        <tr>
          <td class="section-label">客先</td><td style="width:20%;">オークマ株式会社</td>
          <td class="section-label">発行No.</td><td><input type="text" name="customer_no" placeholder="例: TTS60-01-648" /></td>
          <td class="section-label">発行年月日</td>
          <td><input type="date" name="hakkohiduke" class="no-print" /><span class="print-text" data-from="hakkohiduke"></span></td>
        </tr>
        <tr><td class="section-label">機種</td><td>MB-80V</td><td class="section-label">品番</td><td><input type="text" name="part_no" placeholder="例: H1090-0053-07-1" /></td><td class="section-label">図番</td><td>3303-20</td></tr>
        <tr>
          <td class="section-label">品名</td><td>X軸(左側)SG</td>
          <td class="section-label">製造日</td><td><input type="date" name="makingdate" class="no-print" /><span class="print-text" data-from="makingdate"></span></td>
          <td class="section-label">製造No</td><td><input type="text" name="serial_no" placeholder="例: XL3303-223" /></td>
        </tr>
        <tr class="order-no-row"><td class="section-label">オーダーNo</td><td class="data" colspan="5"><input type="text" name="order_no" placeholder="例: 102P068219-001" /></td></tr>
      </table>

      <div class="inputter-row no-print">
        <label>入力者</label>
        <select name="inputter">
          <option value="">- 選択してください -</option>
          <option value="長谷部">長谷部</option><option value="都合">都合</option>
          <option value="石橋">石橋</option><option value="ワーユ">ワーユ</option>
          <option value="ユスフ">ユスフ</option>
        </select>
      </div>
     <table>
        <tr><th>項目</th><th>基準値</th><th>測定値</th></tr>
        <tr><td>収縮時長さ(a)</td><td>435 mm以下</td>
          <td class="td-measure"><div class="td-measure-grid">
            <input type="text" inputmode="numeric" name="a_length" placeholder="0-435" data-min="0" data-max="435"/><span>mm</span>
          </div></td></tr>
        <tr><td>伸長時長さ(b)</td><td>2,065 mm以上</td>
          <td class="td-measure"><div class="td-measure-grid">
            <input type="text" inputmode="numeric" name="b_length" placeholder=">=2065" data-min="2065"/><span>mm</span>
          </div></td></tr>
        <tr><td>カバーストローク(s)</td><td>1,630 mm以上</td>
          <td class="td-measure"><div class="td-measure-grid">
            <input type="text" inputmode="numeric" name="c_length" placeholder=">=1630" data-min="1630"/><span>mm</span>
          </div></td></tr>
        <tr><td>初期摺動抵抗</td><td>7.0 kg以下</td>
          <td class="td-measure"><div class="td-measure-grid">
            <input type="text" inputmode="decimal" step="0.1" name="start_resist" placeholder="0-7.0" data-min="0" data-max="7"/><span>kg</span>
          </div></td></tr>
        <tr><td>中期摺動抵抗</td><td>7.0 kg以下</td>
          <td class="td-measure"><div class="td-measure-grid">
            <input type="text" inputmode="decimal" step="0.1" name="mid_resist" placeholder="0-7.0" data-min="0" data-max="7"/><span>kg</span>
          </div></td></tr>
        <tr><td>終期摺動抵抗</td><td>7.0 kg以下</td>
          <td class="td-measure"><div class="td-measure-grid">
            <input type="text" inputmode="decimal" step="0.1" name="end_resist" placeholder="0-7.0" data-min="0" data-max="7"/><span>kg</span>
          </div></td></tr>
      </table>

      <div style="margin:2mm 0;">
        <label style="font-weight:bold;">総合判定</label>
        <select name="final_judgment" class="no-print judge-select" style="margin-left:10mm;"><option>合</option><option>否</option></select>
        <span class="print-text"></span>
      </div>
      <div style="margin:2mm 0;"><label style="font-weight:bold;">[備考]</label><input type="text" name="bikou" style="width:70%;" /></div>

      <button type="button" class="button no-print" onclick="printViaPDF()">印刷</button>
      <button type="button" class="button no-print" onclick="saveAsPDF()">PDF保存</button>
      <button type="button" class="button no-print" id="clearAllBtn">全クリア</button>

      <div class="company-name">東京精密発條株式会社</div>
      <div class="stamp-box-row">
        <div>
          <select class="no-print" onchange="updateStampPreview('stamp1',this.value)">
            <option value="">- 印鑑選択 -</option>
            <option value="nakagawa.png">中川部長</option><option value="hasebe.png">長谷部</option>
            <option value="ishibashi.png">石橋</option><option value="togo.png">都合</option>
            <option value="wahyu.png">ワーユ</option><option value="yusuf.png">ユスフ</option>
          </select>
          <div class="stamp-label">検印</div><div class="signature-box"><img id="stamp1" src="" alt=""></div>
        </div>
        <div>
          <select class="no-print" onchange="updateStampPreview('stamp2',this.value)">
            <option value="">- 印鑑選択 -</option>
            <option value="nakagawa.png">中川部長</option><option value="hasebe.png">長谷部</option>
            <option value="ishibashi.png">石橋</option><option value="togo.png">都合</option>
            <option value="wahyu.png">ワーユ</option><option value="yusuf.png">ユスフ</option>
          </select>
          <div class="stamp-label">検査印</div><div class="signature-box"><img id="stamp2" src="" alt=""></div>
        </div>
      </div>
    </div>
  </form>
  <script>
    /* ===== KONFIG — PASTE Content URL DI SINI ===== */
    const GAS_WEBAPP_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgkwBm_n74jSo0yh0oGMeLqY35pVmP52_--_-_xmN35zBz7FKsQYfm9c3SEnJojs-s33VA9B5NlAODoWX_gsUo4Z93jD_c7MAkd8DgXI6j73wkKNUUNXm88BlQ5qnb97Gtt_Zdfcj9g3kaKW6ixBkGVh1NQdXqF_vhVdGv72COdiJbVR7zVvyhiVhLN8QFuash0q04iegaaZNyAQbOGjYQ-u5UnP1kQXNhlAYS5H0LLQHlb6oSox4howhy9dgFex9OE8I-ZgTb7tBwb-2lTSmaKZvKpzG08z3h7gY38&lib=MOX3jNDQOVqzRQefDla-VHsUn87JT-eJS';
    const DRIVE_FOLDER_ID = '1Otvs6p1g9stLY9St3EDCNF2pAYwxViFr';
    const GAS_API_KEY = ''; // kalau API_KEY di Code.gs diisi, samakan di sini

    function updateStampPreview(id, src){ document.getElementById(id).src = src || ''; }
    function clearAllFields(){
      const f = document.getElementById('inspection-form');
      f.reset(); ['stamp1','stamp2'].forEach(id => document.getElementById(id)?.setAttribute('src',''));
      f.querySelectorAll('.td-measure-grid input.invalid').forEach(el => el.classList.remove('invalid'));
      wireJudgeMirror(); wireDateMirror();
    }
    document.getElementById('clearAllBtn')?.addEventListener('click', clearAllFields);

    // Validasi angka (dipersingkat)
    (function(){
      document.querySelectorAll('.td-measure-grid input').forEach(inp=>{
        const allowDecimal = (inp.getAttribute('step')||'').includes('.');
        const reInt=/^\d{0,3}$/, reDec=/^\d{0,3}(\.\d{0,1})?$/;
        const getMin=()=>parseFloat(inp.dataset.min ?? '-Infinity');
        const getMax=()=>parseFloat(inp.dataset.max ?? 'Infinity');
        inp.addEventListener('input',()=>{
          let v=inp.value.replace(/[^\d.]/g,'');
          const p=v.indexOf('.'); if(p!==-1)v=v.slice(0,p+1)+v.slice(p+1).replace(/\./g,'');
          if(v.includes('.')){const[d,f]=v.split('.'); v=(allowDecimal?`${d.slice(0,3)}.${(f??'').slice(0,1)}`:d.slice(0,3));}
          else v=v.slice(0,3);
          if(!(allowDecimal?reDec:reInt).test(v)) v=(v.match(/^\d{0,3}/)?.[0])??'';
          inp.value=v; inp.classList.remove('invalid');
        });
        inp.addEventListener('blur',()=>{
          const v=inp.value; if(v===''){inp.classList.remove('invalid');return;}
          const n=parseFloat(v),min=getMin(),max=getMax();
          if(Number.isNaN(n)||n<(Number.isFinite(min)?min:-Infinity)||n>(Number.isFinite(max)?max:Infinity)){
            inp.value=''; inp.classList.add('invalid');
          }else{ if(allowDecimal) inp.value=n.toFixed(1).replace(/\.0$/,'.0'); inp.classList.remove('invalid');}
        });
      });
    })();

    function wireDateMirror(){
      document.querySelectorAll('input[type="date"]').forEach(inp=>{
        const span=document.querySelector(`.print-text[data-from="${inp.name}"]`); if(!span) return;
        const fmt=v=>v?v.replace(/(\d{4})-(\d{2})-(\d{2})/,'$1/$2/$3'):'';
        const upd=()=>span.textContent=fmt(inp.value); inp.addEventListener('change',upd); upd();
      });
    }
    function wireJudgeMirror(){
      document.querySelectorAll('select.judge-select').forEach(sel=>{
        if(!sel.nextElementSibling || !sel.nextElementSibling.classList.contains('print-text')){
          const span=document.createElement('span'); span.className='print-text'; sel.parentNode.insertBefore(span,sel.nextSibling);
        }
        const span=sel.nextElementSibling; sel.closest('td')?.classList.add('judge-td');
        const upd=()=>span.textContent=sel.value; sel.addEventListener('change',upd); upd();
      });
    }

    async function renderFormCanvas(){
      const el=document.querySelector('.b5-preview');
      return html2canvas(el,{scale:2,backgroundColor:'#FFFFFF',useCORS:true,letterRendering:true,
        onclone:(doc)=>{doc.querySelectorAll('.no-print').forEach(e=>e.style.display='none'); doc.querySelectorAll('.print-text').forEach(e=>e.style.display='inline');}
      });
    }
    async function buildPdfBlobAndName(){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'b5'});
      const canvas=await renderFormCanvas();
      doc.addImage(canvas.toDataURL('image/png'),'PNG',7,7,162,236);
      const makingDate=document.querySelector('input[name="makingdate"]').value;
      const ymd = makingDate ? makingDate.replace(/-/g,'') : (()=>{const t=new Date();return t.getFullYear()+String(t.getMonth()+1).padStart(2,'0')+String(t.getDate()).padStart(2,'0');})();
      const inputter=(document.querySelector('select[name="inputter"]')?.value||'no-name').replace(/[\\/:*?"<>|]/g,'');
      const orderNo =(document.querySelector('input[name="order_no"]').value||'no-order').replace(/[\\/:*?"<>|]/g,'');
      const serialNo=(document.querySelector('input[name="serial_no"]').value||'no-serial').replace(/[\\/:*?"<>|]/g,'');
      return { blob: doc.output('blob'), filename: `${ymd}_${inputter}_${orderNo}_${serialNo}.pdf`, meta:{inputter,orderNo,serialNo} };
    }

    // === SIMPAN KE DRIVE via Apps Script (pakai CONTENT URL) ===
    async function savePdfToDrive(){
      if(!GAS_WEBAPP_URL || !DRIVE_FOLDER_ID){ alert('GAS_WEBAPP_URL / DRIVE_FOLDER_ID belum diisi'); return; }
      try{
        const { blob, filename, meta } = await buildPdfBlobAndName();
        const makingDate = document.querySelector('input[name="makingdate"]')?.value || '';
        const ab = await blob.arrayBuffer();
        let bin=''; const bytes=new Uint8Array(ab); for(let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
        const base64=btoa(bin);

        const payload = { folderId:DRIVE_FOLDER_ID, filename, dataUrl:`data:application/pdf;base64,${base64}`, makingDate, meta, apiKey:GAS_API_KEY||undefined };

        const res = await fetch(GAS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // hindari preflight
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if(!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
        alert(`✅ Tersimpan: ${data.path}\n${data.url}`);
      }catch(err){
        console.error(err);
        alert('❌ Drive保存 gagal: '+ err.message);
      }
    }

    // Fallback lokal
    async function saveAsPDF(){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'b5'});
      const canvas=await renderFormCanvas();
      doc.addImage(canvas.toDataURL('image/png'),'PNG',7,7,162,236);
      const makingDate=document.querySelector('input[name="makingdate"]').value;
      const ymd = makingDate ? makingDate.replace(/-/g,'') : (()=>{const t=new Date();return t.getFullYear()+String(t.getMonth()+1).padStart(2,'0')+String(t.getDate()).padStart(2,'0');})();
      const inputter=(document.querySelector('select[name="inputter"]')?.value||'no-name').replace(/[\\/:*?"<>|]/g,'');
      const orderNo =(document.querySelector('input[name="order_no"]').value||'no-order').replace(/[\\/:*?"<>|]/g,'');
      const serialNo=(document.querySelector('input[name="serial_no"]').value||'no-serial').replace(/[\\/:*?"<>|]/g,'');
      doc.save(`${ymd}_${inputter}_${orderNo}_${serialNo}.pdf`);
    }

    async function printViaPDF(){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'b5'});
      const canvas=await renderFormCanvas();
      doc.addImage(canvas.toDataURL('image/png'),'PNG',7,7,162,236);
      if(doc.autoPrint) doc.autoPrint();
      window.open(doc.output('bloburl'),'_blank');
    }

    window.addEventListener('load',()=>{ wireJudgeMirror(); wireDateMirror(); });
  </script>
</body>
</html>

